# yamllint disable rule:line-length
version: 2.1

orbs:
  circleci-cli: circleci/circleci-cli@volatile
  vrsn: tx3stn/vrsn@volatile

anchors:
  dependabot-branch-regex: &dependabot-branch-regex /^dependabot\/.*/
  ignore-main: &ignore-main
    filters:
      branches:
        ignore:
          - main

  ignore-main-and-dependabot: &ignore-main-and-dependabot
    filters:
      branches:
        ignore:
          - main
          - *dependabot-branch-regex

  only-main: &only-main
    filters:
      branches:
        only:
          - main

  only-dependabot: &only-dependabot
    filters:
      branches:
        only:
          - *dependabot-branch-regex
jobs:
  push-dev-tagged-orb:
    executor: circleci-cli/default
    steps:
      - checkout
      - run:
          name: publish dev tagged orb
          command: circleci orb publish ./.circleci/orb.yml tx3stn/vrsn@dev:$CIRCLE_BRANCH --token $CIRCLECI_ORB_API_TOKEN

  push-live-tagged-orb:
    executor: circleci-cli/default
    steps:
      - checkout
      - run:
          name: publish live orb
          command: |
            VERSION=$(head -n 1 VERSION)
            sed -r "s/\"%%VRSN_VERSION%%\"/$VERSION/g" -i ./.circleci/orb.yml
            circleci orb publish ./.circleci/orb.yml "tx3stn/vrsn@$VERSION" --token $CIRCLECI_ORB_API_TOKEN

  validate-orb:
    executor: circleci-cli/default
    steps:
      - checkout
      - run:
          name: validate orb
          command: circleci orb validate ./.circleci/orb.yml

workflows:
  pull-request-build:
    jobs:
      - vrsn/check-version:
          <<: *ignore-main-and-dependabot
      - vrsn/bump-version:
          bump-type: patch
          <<: *only-dependabot
      - validate-orb:
          <<: *ignore-main
      - push-dev-tagged-orb:
          <<: *ignore-main
          requires:
            - validate-orb

  merge-to-main:
    jobs:
      - validate-orb:
          <<: *only-main
      - push-live-tagged-orb:
          <<: *only-main
          requires:
            - validate-orb
